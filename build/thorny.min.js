(function(a){require.paths.unshift(__dirname+"/../");var b=__dirname+"/../",c=typeof window!="undefined"?!0:!1,d=JSON||require("lib/json.js"),e=function(a){if(a.substr(0,2)==="./")return!0;return!1},f=function(a,b){if(c)window.jQuery.ajax({url:a.substr(1),success:b,error:function(a,b){throw new Error("Thorny main.openFile encounted '"+b+"'")},dataType:"text"});else{var d=require("fs");d.readFile(__dirname+"/../"+a,function(a,c){if(a)throw new Error(a);b(c.toString())})}},g=function(a){var b,d,e=a.shift(),f=a.length,g,h=e,i=e,j=function(a){try{if(!c)return require("fs").statSync(a+".js")?{path:a,func:require(a)}:!1;var b=require(a);if(b!==!1)return{path:a,func:b};return!1}catch(d){return!1}};if(f>0){h+=c?"/browser":"/node.js",i+="/common";for(b=0,d=f;b<d;b+=1)h+="/"+a[b],i+="/"+a[b]}return j(h)||j(i)||function(){throw new Error('Unknown module "'+e+(a.length>0?" ":"")+a.join(" ")+'", dont forget that a module must be in a common/browser/node.js subdirectory, ie thorny/common/math/vector2.js')}()},h=function(a,b){var c,d,e,f,h,i,j;e=a.path.split(" "),j=e.length,h=b;for(c=0,d=j;c<d;c+=1)f=e[c],h[f]===undefined&&(c===j-1?(i=g(e),h["* "+f]=i.func,a.autoexec&&(a.module=i.func)):h[f]={}),h=h[f]},i=function(a,b){var g,h,i=[],j=[],k,l;for(g=0,h=a.length;g<h;g+=1)j.push(a[g]);k=function(){if(j.length===0){typeof b=="function"&&b(i);return!1}var a=j.shift(),g=!1,h=!1;if(typeof a=="object"){a.autoexec!==undefined&&a.autoexec===!0&&(g=!0);if(a.omitIfNodejs!==undefined&&a.omitIfNodejs===!0&&!c)return k();if(a.omitIfBrowser!==undefined&&a.omitIfBrowser===!0&&c)return k();a=a.path}a.indexOf(" component ")>0&&a.indexOf(" component ")===a.indexOf(" ")&&(h=!0),e(a)?f(a,function(a){j=d.parse(a).concat(j),k()}):(i.push({path:a,autoexec:g||h,module:!1}),k())},k()},j=function(a,b){var c={},d,e;for(d=0,e=a.length;d<e;d+=1)h(a[d],c);b(c)};a.exports=function(){var a=arguments;return function(b){var e=0,g=!1,h={},k={};i(a,function(a){j(a,function(e){if(b===undefined||typeof b!="function")throw new Error("./thorny/base: Expects a callback function.");var g=function(a){return function(a){var b,c,d=e;b=function(a){a===undefined&&(a="");var b=a.split(" "),e=d,f,g;for(f=0,g=b.length;f<g;f+=1)if(!(e=c(b[f],f===g-1?!0:!1)))return!1;return e},b.find=c=function(b){if(d[b]===undefined){if(d["* "+b]!==undefined){var e=d=d["* "+b];return e(g,a)}return!1}d=d[b];return typeof d=="object"?{find:c}:d};return b(a)}(a||"")};g.find=function(a){return g(a)},g.data=function(a,b,c){c===undefined&&(c=!1),h[a]||(h[a]={}),h[a][b]||(h[a][b]=c);return h[a][b]},g.onInit=function(a,b){k[a]===undefined&&(k[a]=!0,b())},function(){var a={},b=1;g.defined=function(c){if(a[c]!==undefined)return a[c];a[c]="0x"+b,b+=1;return a[c]},g.getDefined=function(b){var c;for(c in a)if(a.hasOwnProperty(c)&&a[c]===b)return c;return!1},g.hasDefined=function(a,b){var c,d,e,f=g.defined(a);for(c=0,d=b.length;c<d;c+=1)if(b[c]===f)return!0;return!1}}(),g.registerGlobal=function(a,b){if(g[a]!==undefined)throw new Error("handle.registerGlobal("+a+", "+b+"); global already registered.");if(typeof b!="function")throw new Error("handle.registerGlobal("+a+", "+b+"); module can only be a function.");g[a]=b},g.openFile=f,g.json=d,c?(require("lib/underscore.js"),g._=_):g._=require("lib/underscore.js"),function(){var b,c,d;for(c=0,d=a.length;c<d;c+=1)b=a[c],b.autoexec&&b.module(g,b.path)}(),b(g)})})}}})(typeof window=="undefined"?module:window.thorny_path("./thorny/base")),function(a){var b;b=function(a,c){return{type:"vector2",getX:function(){return a},getY:function(){return c},getSimpleCoords:function(){return[a,c]},getIntegerCoords:function(){return[Math.round(a),Math.round(c)]},normalize:function(){var d=Math.sqrt(a*a+c*c);d>0&&(d=1/d);return b(a*d,c*d)},add:function(d){return b(a+d.getX(),c+d.getY())},sub:function(d){return b(a-d.getX(),c-d.getY())},translate:function(a,c){var d=a.normalize();return this.add(b(d.getX()*c,d.getY()*c))},cross:function(b){return a*b.getY()-c*b.getX()},dot:function(b){return a*b.getX()+c*b.getY()},magnitude:function(){return Math.sqrt(a*a+c*c)},distance:function(b){var d=b.getX()-a,e=b.getY()-c;return Math.sqrt(d*d+e*e)},angle:function(b){return Math.atan2(b.getY(),b.getX())-Math.atan2(c,a)},sameAs:function(b){if(a===b.getX()&&c===b.getY())return!0;return!1},rotate:function(a){var c=this.normalize(),d=Math.cos(a),e=Math.sin(a),f=c.getX()*d-c.getY()*e,g=c.getX()*e+c.getY()*d;return b(f,g)},rotateToFace:function(a){var c=this.sub(a).normalize(),d=c.getX()*-1,e=c.getY()*-1;return b(d,e)},toRadians:function(){var a=this.normalize();return Math.atan2(a.getY(),a.getX())},clone:function(){return b(a,c)}}},a.exports=function(a){return{factory:b,lineIntersection:function(a,c,d,e){var f,g,h,i,j,k,l,m,n;f=c.getX()-a.getX(),g=c.getY()-a.getY(),h=e.getX()-d.getX(),i=e.getY()-d.getY(),j=f*i-g*h;if(j===0)return!1;k=d.getX()-a.getX(),l=d.getY()-a.getY(),m=(k*i-l*h)/j;if(m<0||m>1)return!1;n=(k*g-l*f)/j;if(n<0||n>1)return!1;return b(a.getX()+m*f,a.getY()+m*g)},centroid:function(a,b,c){var d=function(a,b){return a.translate(b.sub(a),a.distance(b)/2)},e=d(a,b),f=d(b,c);return this.lineIntersection(a,f,c,e)},isLeftOfEdge:function(a,b,c){if((c.getX()-b.getX())*(a.getY()-b.getY())-(c.getY()-b.getY())*(a.getX()-b.getX())>0)return!1;return!0}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/math/vector2")),function(a){var b=0;a.exports=function(a){var c={factory:function(c,d,e){var f=a("thorny level node").factory(a("thorny math vector2").centroid(c,d,e),"poly2",b+=1);f.type="poly2",f.getVector2s=function(){return[c,d,e]},f.getMidpoint=function(){return f},f.sharesEdge=function(a){if(this.sameAs(a))return!1;var b=[],c=this.getVector2s(),d=a.getVector2s(),e,f,g,h;for(e=0,f=c.length;e<f;e+=1)for(g=0,h=d.length;g<h;g+=1)c[e].sameAs(d[g])&&b.push(c[e]);if(b.length===2)return b;return!1},f.uncommonVector2=function(a){var b=this.getVector2s(),c,d,e,f,g;for(d=0,e=b.length;d<e;d+=1){c=!0;for(f=0,g=a.length;f<g;f+=1)b[d].sameAs(a[f])&&(c=!1);if(c)return b[d]}return!1},f.isVector2Internal=function(a){if(a.sameAs(c)||a.sameAs(d)||a.sameAs(e))return!0;var b=d.sub(c),f=e.sub(c),g=(a.cross(f)-c.cross(f))/b.cross(f),h=-(a.cross(b)-c.cross(b))/b.cross(f),i=g+h;if(g>=0&&h>=0&&i<=1)return!0;return!1};return f},findAngles:function(a,b,c){var d=a.distance(b),e=b.distance(c),f=c.distance(a);return[Math.acos((d*d+f*f-e*e)/(2*d*f)),Math.acos((e*e+d*d-f*f)/(2*e*d)),Math.acos((f*f+e*e-d*d)/(2*f*e))]},findDistanceFromLineSegment:function(a,b,c,d){var e=c.distance(b),f=d.distance(b),g=!0,h;a[0]>1.5707963267948966||a[1]>1.5707963267948966?(g=!1,e>f?h=f:h=e):h=Math.sin(a[0])*e;return{distance:h,insideProjection:g}}};return c}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/math/poly2")),function(a){a.exports=function(a){return function(a){var b=[];a.addObserver=function(a){if((typeof a=="function"||typeof a=="object")&&typeof a.notify=="function"){b.push(a);try{a.notify("onRegister",this)}catch(c){}}},a.notifyObservers=function(a){var c=0,d,e;for(d=0,e=b.length;d<e;d+=1)try{b[d].notify(a,this)&&(c+=1)}catch(f){}return c};return a}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/core/observable")),function(a){a.exports=function(a){return function(a){a.notify=function(a,b){if(typeof this[a]=="function")try{this[a](b);return!0}catch(c){try{if(typeof this.notifyHandler=="function"){this.notifyHandler(c);return!0}}catch(d){}}return!1};return a}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/core/observer")),function(a){a.exports=function(a,b){var c={};a.onInit(b,function(){a.data(b,"observable",a("thorny core observable")({})),a.data(b,"belated",{}),a.registerGlobal("event",function(){return c})}),c.bind=function(c,d){var e={};e[c]=d,a.data(b,"observable").addObserver(a("thorny core observer")(e)),a.data(b,"belated")[c]&&(a.data(b,"belated")[c]=undefined,this.trigger(c))},c.trigger=function(c,d){var e=a.data(b,"observable").notifyObservers(c);d===!0&&e===0&&(a.data(b,"belated")[c]=!0)};return c}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/core/event")),function(a){window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}(),window.animStartTime=function(){return window.animationStartTime||window.webkitAnimationStartTime||window.oAnimationStartTime||window.msAnimationStartTime||function(){if(window.mozAnimationStartTime)return window.mozAnimationStartTime;return(new Date).getTime()}}(),a.exports=function(a){return{factory:function(a){var b=0,c=!1,d=window.Stats?!0:!1,e;a===undefined&&(a={}),a.simulationTicksPerSecond===undefined&&(a.simulationTicksPerSecond=25),a.maxFrameSkip===undefined&&(a.maxFrameSkip=25),a.useInterpolation===undefined&&(a.useInterpolation=!0),e=function(b,c,d,e,f){var g=this,h=1e3/a.simulationTicksPerSecond,i=a.maxFrameSkip,j=b,k,l,m=b,n={},o;n.interpolation=function(a){k=0;while(a>j&&k<i)e(j),j+=h,k+=1;l=0,k===0&&(l=(a+h-j)/h),f(l),c(o)},n.noInterpolation=function(a){k=0;while(a>j&&k<i)e(j),f(),j+=h,k+=1;c(o)},o=n[d],o(b)};return{start:function(b,d){c=!0,e(animStartTime(),function(a){!c||requestAnimFrame(function(){a(animStartTime())})},a.useInterpolation?"interpolation":"noInterpolation",b,d)},stop:function(){c=!1,b=0}}}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/browser/core/game-loop")),function(a){a.exports=function(a,b){var c={};a.onInit(b,function(){a.registerGlobal("es",function(){return c}),a.registerGlobal("getTag",function(b){return a.es().tag.get(b)}),a.data(b,"entities",{})}),c.makeEntity=function(){var c=a("thorny entity-system entity")(arguments);a.data(b,"entities")[c.id]=a("thorny core observer")({entity:c,remove:function(c){a.data(b,"entities")[c.id]=undefined}});return c},c.getEntity=function(c){if(a.data(b,"entities")[c]!==undefined)return a.data(b,"entities")[c].entity;return!1},c.inject={entity:function(b){a("thorny entity-system entity").inject(b)},system:function(a){a(c)}},c.tag=a("thorny entity-system tag"),c.template=a("thorny entity-system templateable"),c.spawn=a("thorny entity-system spawnable"),c.component=a("thorny entity-system component");return c}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/entity-system/base")),function(a){a.exports=function(a,b){a.onInit(b,function(){var b={};a.es().inject.entity(function(c){c.openFile=function(c,d){var e=this;b[e.id]===undefined&&(b[e.id]={count:0,events:[]}),b[e.id].count+=1,a.openFile(c,function(a){d(a),b[e.id].count-=1;if(b[e.id].count===0){var c,f,g=b[e.id].events;for(c=0,f=g.length;c<f;c+=1)e.triggers(g[c])}});return this},c.triggers=function(){var d,e,f;if(b[c.id]===undefined||b[c.id].count===0)for(d=0,e=arguments.length;d<e;d+=1)a.event().trigger(arguments[d],!0);else{var f=b[c.id].events;for(d=0,e=arguments.length;d<e;d+=1)a._.include(f,arguments[d])||f.push(arguments[d])}return this}})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/entity-system/hooks")),function(a){a.exports=function(a,b){a.onInit(b,function(){a.data(b,"nextId",function(){var a=0;return function(){return a+=1}}()),a.data(b,"injectors",[])});var c=function(c){var d,e,f,g=a("thorny core observable")({id:a.data(b,"nextId")(),remove:function(){this.notifyObservers("remove")}}),h=a.data(b,"injectors"),d,e;c===undefined&&(c=[]);for(d=0,e=h.length;d<e;d+=1)h[d](g);for(d=0,e=c.length;d<e;d+=1)switch(c[d]){case a.defined("template"):g.makeTemplate();break;case a.defined("---"):}return g};c.inject=function(c){typeof c=="function"&&a.data(b,"injectors").push(c)};return c}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/entity-system/entity")),function(a){a.exports=function(a,b){a.onInit(b,function(){a("thorny entity-system entity").inject(function(b){b.addTag=function(b){a.es().tag.create(this,b);return this}}),a.data(b,"entity-tags",{}),a.data(b,"tags-entity",{})});return{create:function(c,d){var e=a("thorny core observer")({entity:c,tag:d,remove:function(c){if(a.data(b,"entity-tags")[c.id]!==undefined){var d=a.data(b,"entity-tags")[c.id],e,f;for(e=0,f=d.length;e<f;e+=1)a.data(b,"tags-entity")[d[e].tag]=undefined;a.data(b,"entity-tags")[c.id]=undefined}}});c.addObserver(e),a.data(b,"entity-tags")[c.id]===undefined&&(a.data(b,"entity-tags")[c.id]=[]),a.data(b,"entity-tags")[c.id].push(e),a.data(b,"tags-entity")[d]=e;return this},get:function(c){if(a.data(b,"tags-entity")[c]!==undefined)return a.data(b,"tags-entity")[c].entity;return!1},remove:function(c){var d=a.data(b,"tags-entity")[c].id;a.data(b,"tags-entity")[c]=undefined,a.data(b,"entity-tags")[d]=undefined;return this}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/entity-system/tag")),function(a){a.exports=function(a,b){a.onInit(b,function(){a("thorny entity-system entity").inject(function(c){c.makeTemplate=function(){a.data(b,"templates")[this.id]=!0;return this},c.isTemplate=function(){if(a.data(b,"templates")[c.id]!==undefined)return a.data(b,"templates")[c.id];return!1},c.appendTemplate=function(c,d){if(!this.isTemplate())return!1;a.data(b,"components")[this.id]===undefined&&(a.data(b,"components")[this.id]=[]),a.data(b,"components")[this.id].push({name:c,options:d});return!0},c.useTag=function(c){var d=a.hasDefined("concrete",arguments),e=[];c=a("thorny entity-system base").tag.get(c);if(!c||d&&!c.isTemplate()||!d&&(!this.isTemplate()||!c.isTemplate()))return!1;a.data(b,"components")[c.id]!==undefined&&(e=e.concat(a.data(b,"components")[c.id])),a.data(b,"components")[this.id]!==undefined&&(e=e.concat(a.data(b,"components")[this.id])),a.data(b,"components")[this.id]=e,d&&this.concrete();return this},c.concrete=function(){var c,d,e,f=a.data(b,"components")[this.id];a.data(b,"templates")[this.id]=undefined;for(c=0,d=f.length;c<d;c+=1){e=f[c];if(e.name===undefined)continue;typeof e.options=="function"?this.addComponent(e.name,e.options()):this.addComponent(e.name,e.options)}return this}}),a.data(b,"templates",{}),a.data(b,"components",{})});return{}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/entity-system/templateable")),function(a){a.exports=function(a,b){a.onInit(b,function(){a("thorny entity-system entity").inject(function(a){a.spawn=function(){return this}})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/entity-system/spawnable")),function(a){a.exports=function(a,b){a.onInit(b,function(){a.data(b,"registered-components",{}),a.data(b,"entities",{}),a.es().inject.entity(function(c){c.addComponent=function(d,e){var f=a.data(b,"registered-components")[d];if(f===undefined)throw new Error("entity.addComponent("+d+', "'+JSON.stringify(e)+'"); is unknown');f=f();if(f.isUnique&&this.hasComponent(d))throw new Error("entity.addComponent("+d+', "'+JSON.stringify(e)+'"); in unique, can cannot be added multiple times to one entity');if(this.isTemplate()){this.appendTemplate(d,e);return this}if(f.attach(c,e)===!1)return!1;a.data(b,"entities")[this.id]===undefined&&(a.data(b,"entities")[this.id]={}),f.isUnique?a.data(b,"entities")[this.id][d]=f:(a.data(b,"entities")[this.id][d]===undefined&&(a.data(b,"entities")[this.id][d]=[]),a.data(b,"entities")[this.id][d].push(f));return this},c.getComponent=function(c){if(a.data(b,"entities")[this.id]!==undefined&&a.data(b,"entities")[this.id][c]!==undefined)return{data:a.data(b,"entities")[this.id][c],each:function(b){var c=this.data;c.length===undefined&&(c=[c]),a._.each(c,b)},first:function(a){var b=this.data;b.length===undefined&&(b=[b]),b[0]!==undefined&&a(b[0])}};return!1},c.hasComponent=function(c){if(a.data(b,"entities")[this.id]!==undefined&&a.data(b,"entities")[this.id][c]!==undefined)return!0;return!1},c.executeComponent=function(a){var b=this;this.getComponent(a).each(function(a){a.execute(b)})}}),a.es().inject.system(function(c){c.registerComponent=function(c,d){if(a.data(b,"registered-components")[c]!==undefined)throw new Error('entity-system.registerComponent("'+c+'"); has already been registered');a.data(b,"registered-components")[c]=function(){return a._.extend(function(){return{isUnique:!0,processAsCollection:!1,attach:function(a,b){},update:function(a,b){},execute:function(a,b,c){},expose:function(a){},inject:function(a,b,c){}}}(),d())}},c.searchByComponents=function(){var c=arguments,d=c.length,e=a.data(b,"entities"),f;return{data:a._.map(e,function(b,c){return a.es().getEntity(c)}).reduce(function(a,b,e){var f=0,g,h;for(g=0,h=d;g<h;g+=1)b.hasComponent(c[g])&&(f+=1);d===f&&a.push(b);return a},[]),each:function(b){a._.each(this.data,function(a){var e=[],f,g;for(f=0,g=d;f<g;f+=1)e.push(a.getComponent(c[f]));b.apply(a,e)})},first:function(a){var b=this.data[0],e=[],f,g;for(f=0,g=d;f<g;f+=1)e.push(b.getComponent(c[f]));a.apply(b,e)}}}})});return!1}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/entity-system/component")),function(a){a.exports=function(a,b){a.onInit(b,function(){a.data(b,"loaded-levels",{}),a.es().registerComponent("load-level",function(){return{data:!1,isUnique:!1,processAsCollection:!0,asynchronousAttachEvent:"load-level-completed",attach:function(b,c){var d=this;if(typeof c!="string")return!1;b.openFile(c,function(e){if(d.data===!1){e=a.json.parse(e),a.level().validateNotMalformed(e);var f,g,h=b.getComponent("load-level");h.each(function(a){if(a.data!==!1&&a.data.loadedLevelType!==e.type)throw new Error("component.load-level.attach("+b.id+', "'+c+'"); unable to attach file because type not '+a.data.level.loadedLevelType)}),d.data=a.level(e),h.each(function(a){if(d!==a&&a.data!==!1){var b,c,f,g,h;for(b=0,c=e.network.length;b<c;b+=1)e.network[b].name===a.data.name&&(g=d.data.iterator().stepTo(e.network[b].from).node,h=a.data.iterator().stepTo(e.network[b].to).node,f=g.distance(h),g.addNeighbour(h,{distanceTo:f}),h.addNeighbour(g,{distanceTo:f}))}})}})}}})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/component/load-level")),function(a){var b=function(){return{}},c=function(){return{from:!1,to:!1}};a.exports=function(a,b){a.es().registerComponent("pathfindable",function(){return{attach:function(a,b){},execute:function(b,d){d=a._.extend(c(),d);if(!d.from||!d.to)return!1}}})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/component/pathfindable")),function(a){var b=function(a,b){typeof b!="object"&&(b={});return a._.extend(function(){return{system:!1}}(),b)};a.exports=function(c){c.onInit(a,function(){c.data(a,"draw",{}),c.es().registerComponent("renderer",function(){return{attach:function(d,e){e=b(c,e),c.data(a,"draw")[d.id]=c("thorny renderer "+e.system).attach(e)},execute:function(b){c.data(a,"draw")[b.id]()}}})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/browser/component/renderer")),function(a){a.exports=function(a,b){a.onInit(b,function(){a.data(b,"positions",{}),a.es().registerComponent("drawable",function(){})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/component/drawable")),function(a){var b=function(a,b){typeof b!="object"&&(b={});return a._.extend(function(){return{position:{x:0,y:0},facing:{x:0,y:0}}}(),b)};a.exports=function(a,c){a.onInit(c,function(){a.data(c,"positions",{}),a.es().registerComponent("position",function(){return{attach:function(d,e){e=b(a,e),a.data(c,"positions")[d.id]={position:a("thorny math vector2").factory(e.position.x,e.position.y),facing:a("thorny math vector2").factory(e.facing.x,e.facing.y).normalize()}},execute:function(b){return a.data(c,"positions")[b.id]},expose:function(b){return a.data(c,"positions")[b.id]}}})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/component/position")),function(a){var b=function(a,b){typeof b!="object"&&(b={});return a._.extend(function(){return{user_facing:{x:0,y:0},speed:1,easing:"linear"}}(),b)};a.exports=function(a,c){a.onInit(c,function(){a.data(c,"moveable",{}),a.es().registerComponent("moveable",function(){return{attach:function(d,e){if(!d.hasComponent("position"))return!1;e=b(a,e),a.data(c,"moveable")[d.id]=a._.extend(d.getComponent("position").data.expose(d),{user_facing:a("thorny math vector2").factory(e.user_facing.x,e.user_facing.y).normalize(),speed:e.speed,easing:e.easing,current_speed:0,injected_processors:[]})},execute:function(b){var d,e,f=a.data(c,"moveable")[b.id],g,h,i=f.facing,j=f.position,k=f.speed,l=f.position.translate(f.facing,k);for(d=0,e=f.injected_processors.length;d<e;d+=1)g=f.injected_processors[d],h=g(b,{direction:i,position:j,distance:k,goal:l}),i=h.direction,j=h.position,k=h.distance,l=h.goal;i&&(f.facing=i,f.position=j.translate(i,k))},expose:function(b){return a.data(c,"moveable")[b.id]},inject:function(b,d){var e=a.data(c,"moveable")[b.id];e.injected_processors.push(d)}}})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/component/moveable")),function(a){var b=function(a,b){typeof b!="object"&&(b={});return a._.extend(function(){return{name:!1,route:[],type:"once",active:!1}}(),b)},c=function(a,b){typeof b!="object"&&(b={});return a._.extend(function(){return{direction:!1,position:!1,distance:!1,goal:!1}}(),b)};a.exports=function(a,d){a.onInit(d,function(){a.data(d,"paths",{}),a.es().registerComponent("follow-path",function(){return{isUnique:!1,processAsCollection:!0,attach:function(c,e){var f=this;if(!c.hasComponent("position")||!c.hasComponent("moveable"))return!1;e=b(a,e);if(e.name===!1)return!1;a.data(d,"paths")[c.id]===undefined&&(a.data(d,"paths")[c.id]={}),a.data(d,"paths")[c.id][e.name]={node:!1,route:f.vectorifyRoute(e.route),type:e.type,target:!1},c.getComponent("moveable").data.inject(c,function(b,c){return f.execute(b,a._.extend({path:a.data(d,"paths")[b.id][e.name]},c))})},execute:function(b,d){d=c(a,d);if(d.path!==!1&&d.direction!==!1&&d.position!==!1&&d.distance!==!1&&d.goal!==!1){var e,f,g;d.path.node===!1&&(d.path.node=0,d.path.target=d.path.route[d.path.node],d.direction=d.position.rotateToFace(d.path.target)),d.path.target&&d.position.distance(d.path.target)<d.distance&&(d.path.node+=1,d.path.type==="once"?d.path.node===d.path.route.length?d.path.target=!1:d.path.target=d.path.route[d.path.node]:d.path.type==="cycle"&&(d.path.target=d.path.route[d.path.node%d.path.route.length]),d.path.target?d.direction=d.position.rotateToFace(d.path.target):d.direction=a("thorny math vector2").factory(0,0));return d}},expose:function(b){return a.data(d,"moveable")[b.id]},inject:function(b,c,e){var f=a.data(d,"moveable")[b.id];if(f.validity_tests[c]!==undefined)throw new Error('TODO - Inject cannot replace the functionality in "'+c+'"');f.validity_tests[c]=e},vectorifyRoute:function(b){var c,d,e,f=[],g;for(c=0,d=b.length;c<d;c+=1){e=b[c];if(typeof e!="object")continue;if(e.x!==undefined&&e.y!==undefined)g=a("thorny math vector2").factory(e.x,e.y);else if(e.getX!==undefined&&e.getY!==undefined&&typeof e.getX=="function"&&typeof e.getY=="function")g=e;else continue;f.push(g)}return f}}})})}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/component/follow-path")),function(a){a.exports=function(a,b){var c={};a.onInit(b,function(){a.registerGlobal("level",function(a){if(a===undefined)return c;c.validateNotMalformed(a);var b=c.dataType(a.type),d=c.parse(a,b),e=c.network(d,b);return e})}),c.dataType=function(b,c){if(c===!0)return a(b);return a("thorny level "+b)},c.parse=function(b,c){var d=a("thorny level node-collection").factory(a("thorny level node").factory(a("thorny math vector2").factory(b.x,b.y),b.name));d.loadedLevelType=b.type,d.xySearch=c.xySearch,d.name=b.name,d.getWidth=function(){return b.width},d.getHeight=function(){return b.height};return c.parse(b.name,d,b.data)},c.network=function(a,b){return b.network(a)},c.validateNotMalformed=function(a){if(a.name===undefined||a.type===undefined||a.x===undefined||a.y===undefined||a.width===undefined||a.height===undefined||a.data===undefined||a.network===undefined)throw new Error("Thorny.level: Attempted to load malformed level");return!0};return!1}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/level/base")),function(a){a.exports=function(a){return{factory:function(b){var c=this.formatArguments(arguments,1),d=a("thorny level node-collection").factory();b.isNode=function(a){if(c===a)return!0;return!1},b.getId=function(){return c},b.addNeighbour=function(a,b){if(this===a)return!1;if(d.push(a,b)===!1)return!1;return this},b.getNeightbours=function(){return d.iterator()};return b},formatArguments:function(a,b){var c,d,e="";b===undefined&&(b=0);for(c=b,d=a.length;c<d;c+=1)e+=(e.length===0?"":"-")+a[c];return e}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/level/node")),function(a){a.exports=function(a){return{factory:function(b){var c={},d=[],e={};b===undefined&&(b={}),b.push=function(a,b){if(a.isNode===undefined||a.getId===undefined||a.addNeighbour===undefined||a.getNeightbours===undefined)throw new Error("Thorny level.node_collection: Parsed non-node based object.");if(c[a.getId()]!==undefined)return!1;c[a.getId()]=a,d.push(a),b===undefined&&(b={}),e[a.getId()]=b;return this},b.remove=function(a){return this},b.search=function(){var b=a("thorny level node").formatArguments(arguments);if(c[b]!==undefined)return{node:c[b],details:e[c[b].getId()]};return!1},b.iterator=function(){var a=0;return{next:function(){a+=1},rewind:function(){a=0},current:function(){var b=d[a];if(b===undefined)return!1;return{node:b,details:e[b.getId()]}},valid:function(){if(a<d.length)return!0;return!1},key:function(){return a},step:function(){var a=!1;this.valid()&&(a=this.current(),this.next());return a},getLength:function(){return d.length},stepTo:function(b){a=b;return this.step()}}};return b}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/level/node-collection")),function(a){a.exports=function(a,b){var c={};c.parse=function(b,c,d){var e={},f=0,g,h,i,j,k,l,m;for(g=0,h=d.length;g<h;g+=1){i=[];for(j=0,k=d[g].length;j<k;j+=1)l=d[g][j],m=l.x+"-"+l.y,e[m]===undefined&&(e[m]=a("thorny level node").factory(a("thorny math vector2").factory(l.x+c.getX(),l.y+c.getY()),b,"vector2",f),f+=1),i.push(e[m]);if(i.length!==3)throw new Error("Thorny.level: Invalid level data, all poly2's must contain 3 vertices.");c.push(a("thorny math poly2").factory(i[0],i[1],i[2]))}return c},c.network=function(a){var b,c=a.iterator(),d,e=a.iterator(),f;while(b=c.step()){while(d=e.step())(f=b.node.sharesEdge(d.node))&&b.node.addNeighbour(d.node,{distanceTo:b.node.getMidpoint().distance(d.node.getMidpoint()),edgeWidth:f[0].distance(f[1])});e.rewind()}return a},c.xySearch=function(b,c,d,e){var f,g,h,i=!1,j=!1,k=!1,l=!1;e===undefined&&(e=!1),f=a("thorny math vector2").factory(c,d),b.getComponent("load-level").each(function(a){if(i===!1){if(!e&&(c<a.data.getX()||c>a.data.getX()+a.data.getWidth()||d<a.data.getY()||d>a.data.getY()+a.data.getHeight()))return;g=a.data.iterator();while(h=g.step().node){if(h.isVector2Internal(f)){i=h;return}if(e){k=f.distance(h);if(l===!1||k<l)j=h,l=k}}}});if(i)return i;if(e)return j;return!1};return c}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/level/2d/mesh")),function(a,b){var c=function(a,b){var c,d;for(c=0,d=a.length;c<d;c+=1)if(a[c]===b)return!1;a.push(b);return!0},d=function(a,b){var c,d;for(c=0,d=a.length;c<d;c+=1)if(a[c]===b)return!0;return!1},e=function(a,b){var c,d;for(c=0,d=a.length;c<d;c+=1)if(a[c]===b)return a.slice(0,c).concat(a.slice(c+1,a.length));return!1},f=function(a,b){return Math.abs(a.getX()-b.getX())+Math.abs(a.getY()-b.getY())},g=function(a,d,e,f,g,h){var i,j=0;g!==!1&&(j=d[g.getId()]!==b?d[g.getId()].traveled:0,j+=h),i=j+f;if(!c(a,e)){d[e.getId()]&&j<d[e.getId()].traveled&&(d[e.getId()].parent=g.getId(),d[e.getId()].heuristic=f,d[e.getId()].traveled=j,d[e.getId()].toGoal=i);return!1}if(d[e.getId()]!==b)return!1;d[e.getId()]={node:e,parent:g===!1?!1:g.getId(),heuristic:f,traveled:j,toGoal:i}},h=function(a,c,d,e,f,h){var i=d.getNeightbours(),j,k,l;while(j=i.step()){if(j.details.edgeWidth!==b&&j.details.edgeWidth!==!1&&f!==b&&f>j.details.edgeWidth)continue;g(a,c,j.node,h(d,j.node),d,j.details.distanceTo)}},i=function(a,b,c){var e=!1,f=!1,g,h,i,j;for(i=0,j=a.length;i<j;i+=1){g=a[i];if(d(b,g))continue;h=c[g.getId()].toGoal;if(f===!1||f>=h)e=g,f=h}return e},j=function(a,c,d){d===b&&(d=[]);var e=a[a[c.getId()].parent];if(e===b){d.push(c);return d.reverse()}d.push(c);return j(a,e.node,d)};a.exports=function(a){return{search:function(a,k,l,m){var n=[],o=[],p={},q=!1,r,s,t,u,v;m===b&&(m=f),g(n,p,a,m(a,k),!1),r=[];for(;;){if(a===!1)throw new Error("Thorny Astar: Cannot find viable path.");if(n.length===0||a===k){r=j(p,k);break}for(u=0,v=n.length;u<v;u+=1){if(d(o,n[u]))continue;h(n,p,a,k,l,m)}c(o,a),n=e(n,a),a=i(n,o,p)}return r},__specs:function(){return{addUniqueToList:c,isUniqueInList:d,removeUniqueFromList:e,calculateHeuristic:f,addToSearch:g,addChildrenToOpen:h,pickBestFromOpen:i,minePath:j}}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/level/pathfinder/astar")),function(a,b){a.exports=function(a){var c=!1;return{process:function(a,c,d,e){var f=this.edgeify(d),g;if(d.length===0)return[];if(e===b||e<=0)return this.funnel(a,c,f,f);g=this.pointify(d,f,e);return this.funnel(a,c,f,g)},edgeify:function(a){var b=[],c,d,e={},f,g,h,i,j,k,l,m,n,o,p;if(a.length===0)return[];if(a.length===1)return a[0].getVector2s();c=a[0].sharesEdge(a[1]),e[c[0].getSimpleCoords().concat(c[1].getSimpleCoords()).join("-")]=!0,e[c[1].getSimpleCoords().concat(c[0].getSimpleCoords()).join("-")]=!0,d=a[0].uncommonVector2(c),b.push(d);for(i=1,j=a.length;i<j;i+=1){c=a[i].sharesEdge(a[i-1]),e[c[0].getSimpleCoords().concat(c[1].getSimpleCoords()).join("-")]=!0,e[c[1].getSimpleCoords().concat(c[0].getSimpleCoords()).join("-")]=!0,f=a[i-1].getVector2s(),g=a[i].getVector2s(),h=!1;for(k=1,l=f.length;k<=l;k+=1){m=k%3;if(h)continue;if(e[f[m].getSimpleCoords().concat(f[k-1].getSimpleCoords()).join("-")])continue;if(!f[m].sameAs(d)&&!f[k-1].sameAs(d))continue;for(n=1,o=g.length;n<=o;n+=1){p=n%3;if(e[g[p].getSimpleCoords().concat(g[n-1].getSimpleCoords()).join("-")])continue;if(f[k-1].sameAs(g[p])||f[k-1].sameAs(g[n-1]))b.push(f[k-1]),d=f[k-1],h=!0;else if(f[m].sameAs(g[p])||f[m].sameAs(g[n-1]))b.push(f[m]),d=f[m],h=!0}}}c=a[a.length-1].sharesEdge(a[a.length-2]),b.push(a[a.length-1].uncommonVector2(c));for(i=a.length-1;i>=1;i-=1){c=a[i-1].sharesEdge(a[i]);for(k=0,l=b.length;k<l;k+=1){if(b[k].sameAs(c[0])){d.sameAs(c[1])||(d=c[1],b.push(c[1]));break}if(b[k].sameAs(c[1])){d.sameAs(c[0])||(d=c[0],b.push(c[0]));break}}}return b},pointify:function(a,b,c){var d=[],e=b.length,f,g,h,i,j,k,l,m,n,o,p,q,r,s=1.5707963267948966;if(e<3)return!1;for(i=0,j=b.length;i<j;i+=1){h=b[i],f=h.translate(h.rotateToFace(b[(i+e-1)%e]),.1),g=h.translate(h.rotateToFace(b[(i+1)%b.length]),.1),o=f.distance(g)/2,p=f.translate(f.rotateToFace(g),o),r=-1;for(k=0,l=a.length;k<l;k+=1)if(a[k].isVector2Internal(p)){r=1;break}d.push(h.translate(h.rotateToFace(p),c*r))}return d},funnel:function(c,d,e,f){var g=e.length,h=[],i=a("thorny level node"),j=a("thorny math vector2"),k=a("thorny math vector2").lineIntersection,l,m,n,o,p,q,r,s=function(a,b){var c,d,h,i;for(h=0,i=g;h<i;h+=1){d=(h+1)%g;if(k(a,b,e[h],e[d])!==!1)return!1;if(o!==h&&q!==h&&k(a,b,f[h],e[h])!==!1)return!1}return!0};l=i.factory(c.clone(),"funnel","from"),m=i.factory(d.clone(),"funnel","to");for(o=0,p=g;o<p;o+=1)h.push(i.factory(f[o].clone(),"funnel",o));for(o=0,p=g;o<p;o+=1)for(q=0,r=g;q<r;q+=1){if(o===q)continue;s(h[o],h[q])&&(n=h[o].distance(h[q]),h[o].addNeighbour(h[q],{distanceTo:n}),h[q].addNeighbour(h[o],{distanceTo:n}))}q=!1,s(l,m)&&(n=l.distance(m),l.addNeighbour(m,{distanceTo:n}),m.addNeighbour(l,{distanceTo:n}));for(o=0,p=g;o<p;o+=1)s(l,h[o])&&(n=l.distance(h[o]),l.addNeighbour(h[o],{distanceTo:n}),h[o].addNeighbour(l,{distanceTo:n}));for(o=0,p=g;o<p;o+=1)s(m,h[o])&&(n=m.distance(h[o]),m.addNeighbour(h[o],{distanceTo:n}),h[o].addNeighbour(m,{distanceTo:n}));return a("thorny level pathfinder astar").search(l,m,b,function(a,b){return a.distance(b)})},renderer:function(a){c=a}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/common/level/pathfinder/funnel")),function(a){require.paths.unshift(__dirname+"/../");var b=__dirname+"/../",c=typeof window!="undefined"?!0:!1,d=JSON||require("lib/json.js"),e=function(a){if(a.substr(0,2)==="./")return!0;return!1},f=function(a,b){if(c)window.jQuery.ajax({url:a.substr(1),success:b,error:function(a,b){throw new Error("Thorny main.openFile encounted '"+b+"'")},dataType:"text"});else{var d=require("fs");d.readFile(__dirname+"/../"+a,function(a,c){if(a)throw new Error(a);b(c.toString())})}},g=function(a){var b,d,e=a.shift(),f=a.length,g,h=e,i=e,j=function(a){try{if(!c)return require("fs").statSync(a+".js")?{path:a,func:require(a)}:!1;var b=require(a);if(b!==!1)return{path:a,func:b};return!1}catch(d){return!1}};if(f>0){h+=c?"/browser":"/node.js",i+="/common";for(b=0,d=f;b<d;b+=1)h+="/"+a[b],i+="/"+a[b]}return j(h)||j(i)||function(){throw new Error('Unknown module "'+e+(a.length>0?" ":"")+a.join(" ")+'", dont forget that a module must be in a common/browser/node.js subdirectory, ie thorny/common/math/vector2.js')}()},h=function(a,b){var c,d,e,f,h,i,j;e=a.path.split(" "),j=e.length,h=b;for(c=0,d=j;c<d;c+=1)f=e[c],h[f]===undefined&&(c===j-1?(i=g(e),h["* "+f]=i.func,a.autoexec&&(a.module=i.func)):h[f]={}),h=h[f]},i=function(a,b){var g,h,i=[],j=[],k,l;for(g=0,h=a.length;g<h;g+=1)j.push(a[g]);k=function(){if(j.length===0){typeof b=="function"&&b(i);return!1}var a=j.shift(),g=!1,h=!1;if(typeof a=="object"){a.autoexec!==undefined&&a.autoexec===!0&&(g=!0);if(a.omitIfNodejs!==undefined&&a.omitIfNodejs===!0&&!c)return k();if(a.omitIfBrowser!==undefined&&a.omitIfBrowser===!0&&c)return k();a=a.path}a.indexOf(" component ")>0&&a.indexOf(" component ")===a.indexOf(" ")&&(h=!0),e(a)?f(a,function(a){j=d.parse(a).concat(j),k()}):(i.push({path:a,autoexec:g||h,module:!1}),k())},k()},j=function(a,b){var c={},d,e;for(d=0,e=a.length;d<e;d+=1)h(a[d],c);b(c)};a.exports=function(){var a=arguments;return function(b){var e=0,g=!1,h={},k={};i(a,function(a){j(a,function(e){if(b===undefined||typeof b!="function")throw new Error("./thorny/base: Expects a callback function.");var g=function(a){return function(a){var b,c,d=e;b=function(a){a===undefined&&(a="");var b=a.split(" "),e=d,f,g;for(f=0,g=b.length;f<g;f+=1)if(!(e=c(b[f],f===g-1?!0:!1)))return!1;return e},b.find=c=function(b){if(d[b]===undefined){if(d["* "+b]!==undefined){var e=d=d["* "+b];return e(g,a)}return!1}d=d[b];return typeof d=="object"?{find:c}:d};return b(a)}(a||"")};g.find=function(a){return g(a)},g.data=function(a,b,c){c===undefined&&(c=!1),h[a]||(h[a]={}),h[a][b]||(h[a][b]=c);return h[a][b]},g.onInit=function(a,b){k[a]===undefined&&(k[a]=!0,b())},function(){var a={},b=1;g.defined=function(c){if(a[c]!==undefined)return a[c];a[c]="0x"+b,b+=1;return a[c]},g.getDefined=function(b){var c;for(c in a)if(a.hasOwnProperty(c)&&a[c]===b)return c;return!1},g.hasDefined=function(a,b){var c,d,e,f=g.defined(a);for(c=0,d=b.length;c<d;c+=1)if(b[c]===f)return!0;return!1}}(),g.registerGlobal=function(a,b){if(g[a]!==undefined)throw new Error("handle.registerGlobal("+a+", "+b+"); global already registered.");if(typeof b!="function")throw new Error("handle.registerGlobal("+a+", "+b+"); module can only be a function.");g[a]=b},g.openFile=f,g.json=d,c?(require("lib/underscore.js"),g._=_):g._=require("lib/underscore.js"),function(){var b,c,d;for(c=0,d=a.length;c<d;c+=1)b=a[c],b.autoexec&&b.module(g,b.path)}(),b(g)})})}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/base")),function(a){var b=function(a,b){typeof b!="object"&&(b={});return a._.extend(function(){return{element:!1,width:320,height:240}}(),b)};a.exports=function(a){return{attach:function(c){c=b(a,c);var d=window.document.getElementById(c.element),e=new Processing(d);e.setup=function(){e.size(c.width,c.height),e.noLoop()},e.draw=function(){e.noStroke(),e.fill(102,51,0),e.rect(0,0,c.width,c.height),e.stroke(51,153,0),e.fill(51,153,0),a.getTag("world").getComponent("load-level").each(function(a){var b=a.data.iterator(),c,d;while(c=b.step())d=c.node.getVector2s(),e.triangle(d[0].getX(),d[0].getY(),d[1].getX(),d[1].getY(),d[2].getX(),d[2].getY())}),a.es().searchByComponents("drawable","position").each(function(a,b){e.fill(98,126,100,200),e.stroke(98,126,100),e.ellipse(b.data.expose(this).position.getX(),b.data.expose(this).position.getY()+8,18,8),e.fill(197,124,201),e.stroke(153,23,116),e.ellipse(b.data.expose(this).position.getX(),b.data.expose(this).position.getY(),16,16)})},e.setup();return function(){e.redraw()}}}}}(typeof window=="undefined"?module:window.thorny_path("./thorny/browser/renderer/processing"))